#!/bin/bash

# FILE_PATH="$HOME/.local/pipx/venvs/xklb/lib/python3.12/site-packages/xklb/createdb/tube_add.py"
# Debian 12 and Ubuntu 23.10 use: /root/.local/pipx/... 
# Debian 13 and Ubuntu 24.04 use: /root/.local/share/pipx/...
# Running 'updatedb' is an ugly hack that might be very slow (optimize later!)
# but at least fixes (a) "share" in path on new OS's (b) Python version in path
updatedb
FILE_PATH=$(locate /site-packages/xklb/mediadb/db_media.py | grep /pipx/venvs/xklb/lib/ | grep '/root/.local' | head -1)

# Check if the patch has already been applied
if grep -q 'entry = {k: v for k, v in entry.items() if v is not None or k == "error"}' "$FILE_PATH"; then
    echo "db_media.py already patched to retain 'error' key when value is None. No changes necessary."
else
    echo "Patching db_media.py to ensure 'error' key is retained even when its value is None."
    sed -i.bak 's/entry = objects\.dict_filter_bool(entry)/entry = {k: v for k, v in entry.items() if v is not None or k == "error"}/' "$FILE_PATH"

    echo "db_media.py has been successfully patched."
fi
